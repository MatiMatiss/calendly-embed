<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendly Embed</title>
</head>
<body>
    <!-- Calendly inline widget begin -->
    <div class="calendly-inline-widget" id="calendly-widget" data-url="https://calendly.com/matiss-lacis-heise/qbr-test" style="min-width:320px;height:700px;"></div>
    <script type="text/javascript" src="https://assets.calendly.com/assets/external/widget.js" async></script>
    <!-- Calendly inline widget end -->

    <script>
        // Function to get URL parameter
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        };

        // Function to inject Account ID into the form
        function injectAccountId(accountId) {
            var iframe = document.querySelector('.calendly-inline-widget iframe');
            if (iframe) {
                try {
                    var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
                    var inputField = innerDoc.querySelector('input[name="account_id"]');
                    if (inputField) {
                        inputField.value = accountId;
                        console.log("Account ID injected: ", accountId);
                        return true;  // Successfully injected
                    } else {
                        console.log("Input field not found.");
                    }
                } catch (e) {
                    console.log("Error accessing iframe content: ", e);
                }
            } else {
                console.log("Iframe not found.");
            }
            return false;  // Injection not successful
        }

        // MutationObserver to detect changes in the iframe's content
        function observeIframe(accountId) {
            var iframe = document.querySelector('.calendly-inline-widget iframe');
            if (iframe) {
                var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
                var observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        console.log("Mutation observed: ", mutation);
                        if (injectAccountId(accountId)) {
                            observer.disconnect();  // Stop observing once injected
                        }
                    });
                });

                observer.observe(innerDoc, {
                    childList: true,
                    subtree: true
                });
            }
        }

        // Retry function to ensure iframe is found
        function waitForIframe(accountId) {
            var attempts = 0;
            var maxAttempts = 10;
            var intervalId = setInterval(function() {
                var iframe = document.querySelector('.calendly-inline-widget iframe');
                if (iframe) {
                    console.log("Iframe found.");
                    iframe.onload = function() {
                        console.log("Iframe loaded.");
                        observeIframe(accountId);
                    };
                    observeIframe(accountId);  // Call it immediately in case iframe is already loaded
                    clearInterval(intervalId);
                } else {
                    attempts++;
                    console.log("Retrying to find the iframe... attempt ", attempts);
                    if (attempts >= maxAttempts) {
                        clearInterval(intervalId);
                        console.log("Max attempts reached. Could not find iframe.");
                    }
                }
            }, 1000);  // Retry every 1000ms
        }

        document.addEventListener('DOMContentLoaded', function () {
            var accountId = getUrlParameter('account_id');
            if (accountId) {
                var calendlyWidget = document.getElementById('calendly-widget');
                if (calendlyWidget) {
                    var calendlyUrl = calendlyWidget.getAttribute('data-url');
                    calendlyUrl += '?account_id=' + accountId;
                    calendlyWidget.setAttribute('data-url', calendlyUrl);
                }

                console.log("Account ID found: ", accountId);

                // Wait for the iframe to load and then start observing
                waitForIframe(accountId);
            } else {
                console.log("No Account ID found in URL");
            }
        });
    </script>
</body>
</html>
